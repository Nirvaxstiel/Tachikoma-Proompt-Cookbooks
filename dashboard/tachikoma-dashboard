#!/bin/bash
# Tachikoma Dashboard Bootstrapper (Standalone)
# - Uses Python and uv from PATH
# - Creates venv if needed
# - Runs the dashboard or tests

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
VENV_DIR="$SCRIPT_DIR/.venv"

# Parse arguments
RUN_TESTS=0
RUN_UNIT_TESTS=0
ARGS=()

for arg in "$@"; do
    case "$arg" in
        --test)
            RUN_TESTS=1
            ;;
        --pytest)
            RUN_UNIT_TESTS=1
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            ARGS+=("$arg")
            ;;
    esac
done

# Detect platform
case "$(uname -s)" in
    MINGW*|MSYS*|CYGWIN*)
        VENV_PYTHON="$VENV_DIR/Scripts/python.exe"
        ;;
    *)
        VENV_PYTHON="$VENV_DIR/bin/python"
        ;;
esac

# Find Python
if ! command -v python &> /dev/null; then
    echo "Error: Python not found in PATH" >&2
    exit 1
fi

# Find uv
if ! command -v uv &> /dev/null; then
    echo "Error: uv not found in PATH. Install with: pip install uv" >&2
    exit 1
fi

# Change to script directory
cd "$SCRIPT_DIR"

# Create venv and sync dependencies using uv
if [ ! -f "$VENV_PYTHON" ]; then
    echo "Creating virtual environment with uv..."
    uv venv
fi

echo "Syncing dependencies..."
uv sync

# Run tests or dashboard
if [ "$RUN_TESTS" = "1" ]; then
    echo "Running dashboard smoke tests..."
    exec uv run python test_smoke_no_rich.py
fi

if [ "$RUN_UNIT_TESTS" = "1" ]; then
    echo "Running pytest unit tests..."
    exec uv run pytest tests/ -v
fi

# Run the dashboard
exec uv run python -m tachikoma_dashboard "${ARGS[@]}"

show_help() {
    echo ""
    echo "Tachikoma Dashboard - Real-time agent monitoring"
    echo ""
    echo "Usage: tachikoma-dashboard [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -i, --interval INT     Refresh interval in milliseconds (default: 2000)"
    echo "  -c, --cwd PATH         Filter by working directory"
    echo "  -a, --all-sessions     Show all sessions"
    echo "  -j, --json             One-shot JSON output (no TUI)"
    echo "  --test                 Run smoke tests"
    echo "  --pytest               Run pytest unit tests"
    echo "  -h, --help             Show this help"
    echo ""
    echo "Examples:"
    echo "  tachikoma-dashboard                  Start dashboard"
    echo "  tachikoma-dashboard --json           Output as JSON"
    echo "  tachikoma-dashboard --test           Run smoke tests"
    echo "  tachikoma-dashboard --pytest         Run unit tests"
    echo ""
}
