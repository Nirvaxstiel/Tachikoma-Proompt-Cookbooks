# Intent Routing Configuration
# Defines how Tachikoma orchestrator routes tasks based on classified intent
# Version: 1.1.2
#
# ⚠️  CRITICAL: Skill vs Subagent Distinction
# -----------------------------------------
# SKILL:    Guidance document that you LOAD and FOLLOW
#           Usage: Read: .opencode/skills/{name}/SKILL.md
#           Then: Execute using tools directly (Edit, Read, Grep, etc.)
#           Examples: code-agent, analysis-agent, research-agent
#
# SUBAGENT: Delegated worker that you INVOKE
#           Usage: task(subagent_type="{name}", ...)
#           Then: Wait for subagent to complete and return result
#           Examples: rlm-subcall, rlm-optimized
#
# NEVER use task() for skills or Read for subagents!
# -----------------------------------------

# ============================================
# INTENT ROUTES
# ============================================
routes:
  # Debug: Finding and fixing issues
  debug:
    description: Finding and fixing issues, troubleshooting
    confidence_threshold: 0.7
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
    skill: code-agent
    skill_load_instruction: "Read: .opencode/skills/code-agent/SKILL.md"
    skill_usage: "Load skill, then follow its workflow (inspect→extract→validate→implement→verify→stop) using tools directly"
    invoke_via: skill  # skill = load and follow | subagent = delegate
    tools:
      - Read
      - Grep
      - Bash
    strategy: direct
    notes: Use for bugs, errors, and broken functionality

  # Implement: Writing or modifying code
  implement:
    description: Writing or modifying code, adding features
    confidence_threshold: 0.7
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
    skill: code-agent
    skill_load_instruction: "Read: .opencode/skills/code-agent/SKILL.md"
    skill_usage: "Load skill, then follow its workflow (inspect→extract→validate→implement→verify→stop) using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Write
      - Edit
      - Bash
    strategy: direct
    notes: Use for new features, components, and implementations

  # Review: Code analysis and auditing
  review:
    description: Analyzing code for quality, auditing
    confidence_threshold: 0.7
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
      - 30-research-methods
    skill: analysis-agent
    skill_load_instruction: "Read: .opencode/skills/analysis-agent/SKILL.md"
    skill_usage: "Load skill, then follow its analysis workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Grep
    strategy: direct
    notes: Use for code quality checks, security audits, and analysis

  # Refactor: Restructuring existing code
  refactor:
    description: Restructuring and improving existing code
    confidence_threshold: 0.7
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
    skill: code-agent
    skill_load_instruction: "Read: .opencode/skills/code-agent/SKILL.md"
    skill_usage: "Load skill, then follow its refactoring workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Write
      - Edit
      - Bash
    strategy: direct
    notes: Use for refactoring, restructuring, and code improvement

  # Research: Investigation and information gathering
  research:
    description: Finding information, investigating
    confidence_threshold: 0.6
    context_modules:
      - 00-core-contract
      - 30-research-methods
    skill: research-agent
    skill_load_instruction: "Read: .opencode/skills/research-agent/SKILL.md"
    skill_usage: "Load skill, then follow its research methodology using tools directly"
    invoke_via: skill
    tools:
      - Read
      - WebFetch
      - Grep
    strategy: direct
    notes: Use for learning APIs, understanding code, exploring solutions

  # Git: Version control operations
  git:
    description: Version control operations, commits, PRs
    confidence_threshold: 0.8
    context_modules:
      - 00-core-contract
      - 20-git-workflow
    skill: git-commit
    skill_load_instruction: "Read: .opencode/skills/git-commit/SKILL.md"
    skill_usage: "Load skill, then follow its git workflow using tools directly"
    invoke_via: skill
    tools:
      - Bash
    strategy: direct
    notes: Use for commits, branches, PRs, and git operations

  # Document: Documentation tasks
  document:
    description: Creating or updating documentation
    confidence_threshold: 0.6
    context_modules:
      - 00-core-contract
      - 12-commenting-rules  # Documentation includes code comments
    skill: self-learning
    skill_load_instruction: "Read: .opencode/skills/self-learning/SKILL.md"
    skill_usage: "Load skill, then follow its documentation workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Write
    strategy: direct
    notes: Use for README updates, docs, and comments

  # Complex: Large context or multi-step tasks
  complex:
    description: Multi-step tasks, large context processing
    confidence_threshold: 0.5
    context_modules:
      - 00-core-contract
    subagent: rlm-optimized
    fallback_subagent: rlm-subcall
    subagent_invoke_instruction: "task(subagent_type='rlm-optimized', description='...', prompt='...')"
    subagent_usage: "Delegate task to subagent and wait for completion"
    invoke_via: subagent  # subagent = delegate via task() | skill = load and follow
    tools:
      - Read
    strategy: rlm
    notes: Use for large codebases, bulk operations, complex analysis (uses MIT-style adaptive chunking)

  # Unclear: When intent cannot be determined
  unclear:
    description: Ambiguous or unclear user intent
    confidence_threshold: 0.0
    context_modules:
      - 00-core-contract
    action: ask
    notes: Ask user for clarification

  # Skill-Compose: Dynamic skill composition for complex tasks
  skill-compose:
    description: Combining multiple skills for compound tasks
    confidence_threshold: 0.6
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
    skill: skill-composer
    skill_load_instruction: "Read: .opencode/skills/skill-composer/SKILL.md"
    skill_usage: "Load skill, then follow its composition workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Grep
      - Bash
    strategy: direct
    notes: Use when task requires multiple specialized skills working together

  # Optimize: Cost-aware routing and context optimization
  optimize:
    description: Token optimization, context pruning, efficiency improvements
    confidence_threshold: 0.7
    context_modules:
      - 00-core-contract
    skill: context-manager
    skill_load_instruction: "Read: .opencode/skills/context-manager/SKILL.md"
    skill_usage: "Load skill, then follow its optimization workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Bash
    strategy: direct
    notes: Use for context cleanup, token reduction, efficiency tuning

  # Verify: Generator-Verifier-Reviser pattern for high-reliability tasks
  verify:
    description: High-reliability code generation with verification loop
    confidence_threshold: 0.6
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
    skill: verifier-code-agent
    skill_load_instruction: "Read: .opencode/skills/verifier-code-agent/SKILL.md"
    skill_usage: "Load skill, then follow its verify workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Write
      - Edit
      - Bash
    strategy: direct
    notes: "Use for: complex implementations, security-critical code, high-stakes fixes."

  # Reflect: Explicit self-verification and reflection
  reflect:
    description: Self-critique and adversarial verification for outputs
    confidence_threshold: 0.6
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
    skill: reflection-orchestrator
    skill_load_instruction: "Read: .opencode/skills/reflection-orchestrator/SKILL.md"
    skill_usage: "Load skill, then follow its reflection workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Write
      - Edit
    strategy: direct
    notes: Use for complex reasoning, high-stakes decisions, and confidence verification.

  # Edit-Optimize: Model-aware edit format selection
  edit-optimize:
    description: Model-specific edit format for maximum success
    confidence_threshold: 0.7
    context_modules:
      - 00-core-contract
    skill: model-aware-editor
    skill_load_instruction: "Read: .opencode/skills/model-aware-editor/SKILL.md"
    skill_usage: "Load skill, then use hashline processor for reliable edits"
    invoke_via: skill
    tools:
      - Read
      - Write
      - Edit
    strategy: direct
    notes: Use when experiencing edit failures or working with multiple models.

# ============================================
# SKILL CHAINS (Multi-Skill Orchestration)
# ============================================
# ⚠️  SKILL CHAIN USAGE:
# Each skill in a chain is loaded INDIVIDUALLY using Read, then executed in sequence.
# Skills in chains follow the same rules as standalone skills - NEVER use task() for them!
#
# Example flow for "implement-verify" chain:
#   1. Read: .opencode/skills/code-agent/SKILL.md
#      → Execute code changes
#   2. Read: .opencode/skills/verifier-code-agent/SKILL.md
#      → Verify the changes
#   3. Read: .opencode/skills/formatter/SKILL.md
#      → Format the result
#
# Mode: sequential = execute one after another
# Mode: parallel = execute simultaneously (if independent)
# ============================================
skill_chains:
  # High-reliability implementation chain
  implement-verify:
    description: "Implementation with verification loop"
    skills:
      - code-agent
      - verifier-code-agent
      - formatter
    skill_load_instructions:
      code-agent: "Read: .opencode/skills/code-agent/SKILL.md"
      verifier-code-agent: "Read: .opencode/skills/verifier-code-agent/SKILL.md"
      formatter: "Read: .opencode/skills/formatter/SKILL.md"
    chain_usage: "Load each skill in sequence using Read, execute following each skill's workflow"
    invoke_via: skill_chain  # Each skill loaded with Read, executed in sequence
    mode: sequential
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards

  # Research-then-implement chain  
  research-implement:
    description: "Research followed by implementation"
    skills:
      - research-agent
      - context7
      - code-agent
      - formatter
    skill_load_instructions:
      research-agent: "Read: .opencode/skills/research-agent/SKILL.md"
      context7: "Read: .opencode/skills/context7/SKILL.md"
      code-agent: "Read: .opencode/skills/code-agent/SKILL.md"
      formatter: "Read: .opencode/skills/formatter/SKILL.md"
    chain_usage: "Load each skill in sequence using Read, execute following each skill's workflow"
    invoke_via: skill_chain
    mode: sequential
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards

  # High-stakes security chain
  security-implement:
    description: "Security-critical implementation"
    skills:
      - context7
      - code-agent
      - verifier-code-agent
      - reflection-orchestrator
    skill_load_instructions:
      context7: "Read: .opencode/skills/context7/SKILL.md"
      code-agent: "Read: .opencode/skills/code-agent/SKILL.md"
      verifier-code-agent: "Read: .opencode/skills/verifier-code-agent/SKILL.md"
      reflection-orchestrator: "Read: .opencode/skills/reflection-orchestrator/SKILL.md"
    chain_usage: "Load each skill in sequence using Read, execute following each skill's workflow"
    invoke_via: skill_chain
    mode: sequential
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards

  # Review with reflection
  deep-review:
    description: "In-depth code review with self-verification"
    skills:
      - analysis-agent
      - reflection-orchestrator
    skill_load_instructions:
      analysis-agent: "Read: .opencode/skills/analysis-agent/SKILL.md"
      reflection-orchestrator: "Read: .opencode/skills/reflection-orchestrator/SKILL.md"
    chain_usage: "Load each skill in sequence using Read, execute following each skill's workflow"
    invoke_via: skill_chain
    mode: sequential
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards

  # Complex research chain
  complex-research:
    description: "Multi-source research with verification"
    skills:
      - research-agent
      - context7
      - reflection-orchestrator
    skill_load_instructions:
      research-agent: "Read: .opencode/skills/research-agent/SKILL.md"
      context7: "Read: .opencode/skills/context7/SKILL.md"
      reflection-orchestrator: "Read: .opencode/skills/reflection-orchestrator/SKILL.md"
    chain_usage: "Load each skill in sequence using Read, execute following each skill's workflow"
    invoke_via: skill_chain
    mode: sequential
    context_modules:
      - 00-core-contract
      - 30-research-methods

# ============================================
# COMPOSITE INTENTS
# ============================================
composite:
  enabled: true
  resolution_strategy: union
  
  definitions:
    - name: implement-and-test
      components:
        - implement
        - debug
      description: Write code and verify it works
      
    - name: research-and-implement
      components:
        - research
        - implement
      description: Investigate then implement solution
      
    - name: refactor-and-test
      components:
        - implement
        - debug
      description: Refactor code with verification

# ============================================
# FALLBACK RULES
# ============================================
fallback:
  # When confidence is below threshold
  low_confidence:
    action: ask
    message: "I'm not sure how to categorize this request. Could you clarify what you're trying to do?"
  
  # When no route matches
  no_match:
    action: ask
    message: "I don't recognize this type of task. Please describe your goal in different terms."
  
  # When skill/agent is unavailable
  unavailable:
    action: escalate
    message: "The requested resource is unavailable. Trying alternative approach..."

# ============================================
# ROUTING BEHAVIOR
# ============================================
behavior:
  # Always load core-contract first
  always_load_core: true
  
  # Maximum number of context modules to load
  max_context_modules: 5
  
  # When to delegate vs handle directly
  delegation_threshold:
    tokens: 2000
    confidence: 0.7
  
  # Whether to report routing decisions to user
  report_routing: true
  
  # Whether to include alternative intents in reports
  report_alternatives: true
  
  # Context coupling rules
  module_coupling:
    # When coding-standards loads, commenting-rules MUST also load
    10-coding-standards:
      must_co_load:
        - 12-commenting-rules
      reason: "Commenting rules are inseparable from coding standards"

# ============================================
# CONTEXT MODULE PRIORITY
# ============================================
# Lower number = higher priority (loaded first)
module_priority:
  00-core-contract: 0
  10-coding-standards: 10
  12-commenting-rules: 12  # Bumped up from 15 - tightly coupled with coding-standards
  20-git-workflow: 20
  30-research-methods: 30
  50-prompt-safety: 50

# ============================================
# RESOURCE TYPE REFERENCE
# ============================================
# Quick lookup for skill vs subagent confusion
#
# SKILLS (Load with Read, execute yourself):
#   code-agent:              .opencode/skills/code-agent/SKILL.md
#   analysis-agent:          .opencode/skills/analysis-agent/SKILL.md
#   research-agent:          .opencode/skills/research-agent/SKILL.md
#   verifier-code-agent:     .opencode/skills/verifier-code-agent/SKILL.md
#   model-aware-editor:      .opencode/skills/model-aware-editor/SKILL.md
#   reflection-orchestrator: .opencode/skills/reflection-orchestrator/SKILL.md
#   skill-composer:          .opencode/skills/skill-composer/SKILL.md
#   context-manager:         .opencode/skills/context-manager/SKILL.md
#   context7:                .opencode/skills/context7/SKILL.md
#   formatter:               .opencode/skills/formatter/SKILL.md
#   git-commit:              .opencode/skills/git-commit/SKILL.md
#   self-learning:           .opencode/skills/self-learning/SKILL.md
#
# SKILL CHAINS (Load each skill with Read, execute in sequence):
#   Each skill in a chain is loaded INDIVIDUALLY using Read
#   Then executed following that skill's workflow
#   Example: implement-verify chain
#     1. Read: .opencode/skills/code-agent/SKILL.md → execute
#     2. Read: .opencode/skills/verifier-code-agent/SKILL.md → execute
#     3. Read: .opencode/skills/formatter/SKILL.md → execute
#
# SUBAGENTS (Delegate with task()):
#   rlm-subcall:    task(subagent_type='rlm-subcall', ...)
#   rlm-optimized:  task(subagent_type='rlm-optimized', ...)
#
# RULES:
#   If route has 'skill:' key → use Read to load
#   If route has 'subagent:' key → use task() to delegate
#   If route has 'skills:' array (chain) → use Read for each, execute in sequence
# ============================================
