#!/usr/bin/env bash
#
# Tachikoma Framework - PATH Installer
#
# Installs the 'tachikoma' command to your system PATH.
# Run this after cloning the repo.
#
# Usage:
#   bash install [--local | --global | --help]
#
# After installation, run 'tachikoma' in any project to install the framework.
#

set -e

# Colors
CYAN='\033[36m'
GREEN='\033[32m'
YELLOW='\033[33m'
MAGENTA='\033[35m'
DIM='\033[2m'
BOLD='\033[1m'
RESET='\033[0m'

# Print functions
p() { printf "$@"; }
pl() { printf "$@\n"; }
success() { pl "  ${GREEN}✓${RESET} $@"; }
warn() { pl "  ${YELLOW}⚠${RESET} $@"; }
error() { pl "  ${RED}✗${RESET} $@"; }
info() { pl "  ${CYAN}ℹ${RESET} $@"; }

# Banner
BANNER="
${CYAN}████████╗ █████╗  ██████╗██╗  ██╗██╗██╗  ██╗ ██████╗ ███╗   ███╗ █████╗
${CYAN}╚══██╔══╝██╔══██╗██╔════╝██║  ██║██║██║ ██╔╝██╔═══██╗████╗ ████║██╔══██╗
${CYAN}   ██║   ███████║██║     ███████║██║█████╔╝ ██║   ██║██╔████╔██║███████║
${CYAN}   ██║   ██╔══██║██║     ██╔══██║██║██╔═██╗ ██║   ██║██║╚██╔╝██║██╔══██║
${CYAN}   ██║   ██║  ██║╚██████╗██║  ██║██║██║  ██╗╚██████╔╝██║ ╚═╝ ██║██║  ██║
${CYAN}   ╚═╝   ╚═╝  ╚═╝ ╚═════╝╚═╝  ╚═╝╚═╝╚═╝  ╚═╝ ╚═════╝ ╚═╝     ╚═╝╚═╝  ╚═╝
${RESET}

${BOLD}${MAGENTA}  TACHIKOMA FRAMEWORK${RESET} ${DIM}v2.0.0${RESET}
${CYAN}  \"Structure at the start, freedom at the end.\"${RESET}
${DIM}
  ═══════════════════════════════════════════════════════${RESET}
"

# Parse args
INSTALL_MODE=""
for arg in "$@"; do
    case "$arg" in
        -l|--local)
            INSTALL_MODE="local"
            ;;
        -g|--global)
            INSTALL_MODE="global"
            ;;
        -h|--help)
            p "$BANNER"
            pl "${YELLOW}Usage:${RESET}"
            pl "  bash install [options]"
            pl ""
            pl "${YELLOW}Options:${RESET}"
            pl "  ${CYAN}-g, --global${RESET}    Install to /usr/local/bin (requires sudo)"
            pl "  ${CYAN}-l, --local${RESET}     Install to ~/.local/bin"
            pl "  ${CYAN}-h, --help${RESET}      Show this help"
            pl ""
            pl "${YELLOW}After installation:${RESET}"
            pl "  Run ${MAGENTA}tachikoma${RESET} in any project to install the framework"
            pl ""
            exit 0
            ;;
    esac
done

# Show banner
p "$BANNER"

# Check if in tachikoma repo
if [ ! -f "package.json" ] || [ ! -d ".opencode" ]; then
    error "Not in Tachikoma repository root"
    pl ""
    pl "  Please run this script from the Tachikoma repo:"
    pl "  ${CYAN}git clone https://github.com/Nirvaxstiel/Tachikoma-Proompt-Cookbooks.git${RESET}"
    pl "  ${CYAN}cd Tachikoma-Proompt-Cookbooks${RESET}"
    pl "  ${CYAN}bash install${RESET}"
    exit 1
fi

# Check for bun
pl "${BOLD}${CYAN}  ══ DETECT RUNTIME ══${RESET}"
pl ""

if command -v bun &> /dev/null; then
    success "Found bun $(bun --version)"
else
    error "Bun is required but not installed"
    pl ""

    OS="$(uname -s)"
    case "$OS" in
        Linux*)
            pl "  ${CYAN}curl -fsSL https://bun.sh/install | bash${RESET}"
            ;;
        Darwin*)
            pl "  ${CYAN}brew install oven-sh/bun/bun${RESET}"
            ;;
        MINGW*|MSYS*|CYGWIN*|Windows_NT*)
            pl "  ${CYAN}winget install Oven.Shell.Bun${RESET}"
            ;;
        *)
            pl "  Visit ${CYAN}https://bun.sh/docs/installation${RESET}"
            ;;
    esac
    exit 1
fi

pl ""

# Determine install location
pl "${BOLD}${CYAN}  ══ INSTALL COMMAND ══${RESET}"
pl ""

if [ -z "$INSTALL_MODE" ]; then
    pl "${YELLOW}Install tachikoma command to:${RESET}"
    pl ""
    pl "  ${CYAN}1)${RESET} Local bin ${DIM}(~/.local/bin)${RESET} - recommended"
    pl "  ${CYAN}2)${RESET} System bin  ${DIM}(/usr/local/bin)${RESET} - requires sudo"
    pl "  ${CYAN}3)${RESET} Skip        ${DIM}(use 'bun run bin/tachikoma.js' instead)${RESET}"
    pl ""
    read -p "  Choice [1]: " choice
else
    choice="1"
    [ "$INSTALL_MODE" = "global" ] && choice="2"
fi

case "$choice" in
    2)
        INSTALL_DIR="/usr/local/bin"
        NEED_SUDO=true
        ;;
    3)
        info "Skipping command installation"
        pl ""
        pl "  ${CYAN}To run tachikoma:${RESET}"
        pl "    bun run bin/tachikoma.js"
        pl ""
        exit 0
        ;;
    *)
        INSTALL_DIR="$HOME/.local/bin"
        NEED_SUDO=false
        ;;
esac

# Create install dir
if [ "$NEED_SUDO" = true ]; then
    info "Creating ${INSTALL_DIR} (may require password)..."
    sudo mkdir -p "$INSTALL_DIR"
else
    info "Creating ${INSTALL_DIR}..."
    mkdir -p "$INSTALL_DIR"
fi

# Copy command
CMD_SRC="bin/tachikoma.js"
CMD_DST="${INSTALL_DIR}/tachikoma"

if [ "$NEED_SUDO" = true ]; then
    info "Installing command (may require password)..."
    sudo cp "$CMD_SRC" "$CMD_DST"
    sudo chmod +x "$CMD_DST"
else
    info "Installing command..."
    cp "$CMD_SRC" "$CMD_DST"
    chmod +x "$CMD_DST"
fi

success "Command installed to ${CMD_DST}"
pl ""

# Check PATH
pl "${BOLD}${CYAN}  ══ PATH CHECK ══${RESET}"
pl ""

if echo "$PATH" | grep -q "$INSTALL_DIR"; then
    success "${INSTALL_DIR} is already in PATH"
    PATH_OK=true
else
    warn "${INSTALL_DIR} is NOT in PATH"
    PATH_OK=false

    pl ""
    pl "  ${YELLOW}Add to PATH:${RESET}"

    SHELL_RC=""
    if [ -n "$ZSH_VERSION" ]; then
        SHELL_RC="$HOME/.zshrc"
    elif [ -n "$BASH_VERSION" ]; then
        SHELL_RC="$HOME/.bashrc"
    else
        SHELL_RC="$HOME/.profile"
    fi

    pl "  echo 'export PATH=\"\$PATH:${INSTALL_DIR}\"' >> ${SHELL_RC}"

    if [ -z "$INSTALL_MODE" ]; then
        read -p "  ${CYAN}Add to ${SHELL_RC} now? [y/N]:${RESET} " add_path
        if [ "$add_path" = "y" ] || [ "$add_path" = "Y" ]; then
            echo "export PATH=\"\$PATH:${INSTALL_DIR}\"" >> "$SHELL_RC"
            success "Added to ${SHELL_RC}"
            info "Run ${CYAN}source ${SHELL_RC}${RESET} or restart your shell"
            PATH_OK=true
        fi
    fi
fi

# Done
pl ""
pl "${BOLD}${GREEN}  ╔══════════════════════════════════════════════════════╗${RESET}"
pl "${BOLD}${GREEN}  ║                                                      ║${RESET}"
pl "${BOLD}${GREEN}  ║  ${RESET}${BOLD}TACHIKOMA COMMAND INSTALLED!${BOLD}${GREEN}                  ║${RESET}"
pl "${BOLD}${GREEN}  ║                                                      ║${RESET}"
pl "${BOLD}${GREEN}  ╚══════════════════════════════════════════════════════╝${RESET}"
pl ""
pl "  ${CYAN}Runtime:${RESET} ${MAGENTA}bun $(bun --version)${RESET}"
pl "  ${CYAN}Location:${RESET} ${MAGENTA}${CMD_DST}${RESET}"
pl ""
pl "  ${CYAN}Next steps:${RESET}"
pl ""
pl "  1. ${YELLOW}cd${RESET} to your project repository"
pl "  2. Run ${MAGENTA}tachikoma${RESET} to install the agent framework"
pl "  3. Choose ${MAGENTA}global${RESET} or ${MAGENTA}local${RESET} installation"
pl ""

if [ "$PATH_OK" = false ]; then
    warn "NOTE: Restart your shell for PATH changes to take effect"
    pl ""
fi

pl "  ${DIM}Documentation: https://github.com/Nirvaxstiel/Tachikoma-Proompt-Cookbooks${RESET}"
pl ""
